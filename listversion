# 1) Get ALL versions of this secret. (-IncludeVersions switch)
$versions = Get-AzKeyVaultSecret `
    -VaultName $vaultName `
    -Name $secretName `
    -IncludeVersions

# 2) Filter to versions that DO have the 'ExpirationDate' tag
$hasExpirationVersions = $versions | Where-Object {
    $_.Tags.ContainsKey("ExpirationDate")
}

# 3) Sort by creation time DESCENDING (newest first) and select the first one
$newestExpiration = $hasExpirationVersions |
    Sort-Object Created -Descending |
    Select-Object -First 1

if ($newestExpiration) {
    Write-Host "Newest version with 'ExpirationDate' for secret '$secretName':"
    Write-Host "  VersionId: $($newestExpiration.Id)"
    Write-Host "  Created:   $($newestExpiration.Created)"
    Write-Host "  ExpirationDate Tag: $($newestExpiration.Tags['ExpirationDate'])"
}
else {
    Write-Host "No versions with 'ExpirationDate' tag found for secret: $secretName"
}
