# 1) Get ALL versions of this secret. (-IncludeVersions switch)
$versions = Get-AzKeyVaultSecret `
    -VaultName $vaultName `
    -Name $secretName `
    -IncludeVersions

# 2) Filter to versions that DO NOT have the 'ExpirationDate' tag
$noExpirationVersions = $versions | Where-Object {
    -not $_.Tags.ContainsKey("ExpirationDate")
}

# 3) Sort by creation time DESCENDING (newest first) and select the first one
$newestNoExpiration = $noExpirationVersions |
    Sort-Object Created -Descending |
    Select-Object -First 1

if ($newestNoExpiration) {
    Write-Host "Newest version WITHOUT 'ExpirationDate' for secret '$secretName':"
    Write-Host "  VersionId: $($newestNoExpiration.Id)"
    Write-Host "  Created:   $($newestNoExpiration.Created)"
}
else {
    Write-Host "No versions without 'ExpirationDate' tag found for secret: $secretName"
}
